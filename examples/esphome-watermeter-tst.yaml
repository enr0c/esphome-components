substitutions:
  name: esphome-watermeter-tst
  friendly_name: esphome-watermeter-tst
    
esphome:
  name: "${name}"
  friendly_name: "${friendly_name}"

esp32:
  board: esp32dev
  framework:
    type: esp-idf

logger:
  # DEBUG logging here can easily starve the CC1101 RX task and cause FIFO overflows.
  # Turn on DEBUG temporarily only when diagnosing reception.
  level: INFO
  tx_buffer_size: 2048
  baud_rate: 115200
  logs:
    component: INFO     # Reduce noise from other components
    esp32: INFO
    spi: INFO
    app: INFO
    wifi: ERROR         # Disable WiFi scan logs
    wmbus: INFO
    wmbus_radio: INFO
    wmbusmeters: INFO
    cc1101: INFO
    packet: INFO

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_watermeter


ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

time:
  - platform: homeassistant

external_components:
  - source: github://enr0c/esphome-components@cc1101-support
    components: [ wmbus_radio, wmbus_meter, wmbus_common ]
    refresh: 0min
# VCC = red
# GND = orange
# MOSI = yellow 
# S/CLK = green
# MISO = blue
# GDO2 =   grey
# GDO0 =  puprple
# CSN =   white

spi:
  clk_pin:  GPIO18  # green
  mosi_pin: GPIO23  # yellow
  miso_pin: GPIO19  # blue


wmbus_radio:
  id: radio
  radio_type: CC1101
  cs_pin: GPIO25  # white
  gdo2_pin:
    number: GPIO27  # grey
    mode: INPUT_PULLDOWN
  gdo0_pin: GPIO4  # puprple
  frequency: 868.95

# wM-Bus common configuration (no specific meters configured - scan all)
wmbus_common:
  # If you don't know the exact meter model/driver yet, keep this as `all`
  # so `type: auto` meters can actually match.
  drivers: 
  - waterstarm

# Add meters so telegrams are considered "handled" and can be decoded.
# IDs below come from your logs (23161062 and 23654508).
wmbus_meter:
  - radio_id: radio
    meter_id: 0x23651845
    type: auto
    mode: [C1]
    key: !secret engelmann_23651845
    on_telegram:
      - lambda: |-
          ESP_LOGI("wmbus_meter", "%s", meter.as_json().c_str());

  - radio_id: radio
    meter_id: 0x22324011
    type: auto
    mode: [C1]
    key: !secret lorenz_22324011
    on_telegram:
      - lambda: |-
          ESP_LOGI("wmbus_meter", "%s", meter.as_json().c_str());